### 트랜잭션(Transaction): 개념, 특징 및 예시 정리

---

## **트랜잭션(Transaction)의 개념**

- **트랜잭션(Transaction)** 은 데이터베이스에서 **하나의 논리적 작업 단위**를 의미합니다.
- 여러 작업(쿼리)이 하나의 트랜잭션으로 묶여 실행되며, 모두 성공하거나 모두 실패해야 합니다.
- 데이터베이스의 일관성을 유지하기 위해 사용되며, 주로 금융 시스템, 주문 처리 시스템 등에서 활용됩니다.

---

## **트랜잭션의 특징 (ACID 속성)**

트랜잭션은 데이터 무결성을 보장하기 위해 **ACID**라는 네 가지 속성을 충족해야 합니다:

### **1. 원자성 (Atomicity)**
- 트랜잭션 내 모든 작업이 **완전히 수행되거나 전혀 수행되지 않아야 함**을 보장합니다.
- 하나라도 실패하면 전체 트랜잭션이 롤백(Rollback)되어 이전 상태로 복구됩니다.

#### 예시:
- 은행 계좌 이체:
  - A 계좌에서 100원을 출금하고 B 계좌에 100원을 입금.
  - 출금이 성공했지만 입금이 실패하면 전체 작업을 취소(롤백).

---

### **2. 일관성 (Consistency)**
- 트랜잭션 실행 전후에 데이터베이스가 항상 **일관된 상태**를 유지해야 합니다.
- 데이터 무결성 제약 조건(예: 외래 키, 고유 키 등)을 위반하지 않아야 합니다.

#### 예시:
- 은행 계좌 잔액 총합이 A 계좌와 B 계좌 간 이체 후에도 변하지 않아야 함.

---

### **3. 고립성 (Isolation)**
- 여러 트랜잭션이 동시에 실행될 때, 각 트랜잭션은 다른 트랜잭션의 중간 결과를 볼 수 없습니다.
- 트랜잭션 간 간섭을 방지하여 독립적으로 실행되도록 보장합니다.

#### 예시:
- 두 사용자가 동시에 같은 상품의 재고를 업데이트하려고 할 때, 한 트랜잭션이 완료되기 전까지 다른 트랜잭션은 영향을 받지 않음.

---

### **4. 지속성 (Durability)**
- 트랜잭션이 성공적으로 완료되면 그 결과는 영구적으로 저장됩니다.
- 시스템 장애가 발생하더라도 완료된 트랜잭션의 결과는 손실되지 않습니다.

#### 예시:
- 주문 생성 후 시스템이 다운되더라도 주문 데이터는 데이터베이스에 영구적으로 저장됨.

---

## **트랜잭션의 상태**

트랜잭션은 다음과 같은 상태를 가질 수 있습니다:

1. **활동(Active)**:
   - 트랜잭션이 실행 중인 상태.
2. **부분 완료(Partially Committed)**:
   - 모든 명령어가 실행되었지만 아직 커밋되지 않은 상태.
3. **완료(Committed)**:
   - 트랜잭션이 성공적으로 완료되어 데이터베이스에 영구적으로 반영된 상태.
4. **실패(Failed)**:
   - 오류가 발생하여 트랜잭션이 중단된 상태.
5. **철회(Aborted)**:
   - 실패한 트랜잭션이 롤백되어 이전 상태로 복구된 상태.

---

## **트랜잭션 제어 명령어**

SQL에서 트랜잭션을 제어하기 위한 주요 명령어는 다음과 같습니다:

1. **`BEGIN` 또는 `START TRANSACTION`**:
   - 새로운 트랜잭션 시작.

2. **`COMMIT`**:
   - 현재 트랜잭션의 모든 작업을 확정하고 데이터베이스에 반영.

3. **`ROLLBACK`**:
   - 현재 트랜잭션의 모든 작업을 취소하고 이전 상태로 복구.

4. **`SAVEPOINT`**:
   - 트랜잭션 내 특정 지점을 저장하여 부분 롤백 가능.

5. **`RELEASE SAVEPOINT`**:
   - 지정한 저장 지점을 삭제.

6. **`SET TRANSACTION`**:
   - 트랜잭션 격리 수준 설정.

---

## **트랜잭션 격리 수준 (Isolation Levels)**

격리 수준은 여러 트랜잭션이 동시에 실행될 때 발생할 수 있는 문제를 방지하기 위해 설정됩니다. 격리 수준이 높을수록 동시성은 낮아지지만 데이터 무결성이 강화됩니다.

| 격리 수준            | 설명                                                                 | 방지되는 문제                      |
|-----------------------|----------------------------------------------------------------------|------------------------------------|
| READ UNCOMMITTED      | 커밋되지 않은 데이터를 읽을 수 있음                                   | 없음                               |
| READ COMMITTED        | 커밋된 데이터만 읽을 수 있음                                         | 더티 리드(Dirty Read)             |
| REPEATABLE READ       | 동일한 쿼리를 반복 실행해도 같은 결과 반환                           | 더티 리드, 반복 가능하지 않은 읽기|
| SERIALIZABLE          | 가장 높은 격리 수준으로, 완전한 직렬화 보장                          | 모든 동시성 문제 방지              |

#### 동시성 문제
1. **더티 리드(Dirty Read)**: 다른 트랜잭션에서 커밋되지 않은 데이터를 읽음.
2. **반복 가능하지 않은 읽기(Non-repeatable Read)**: 동일한 쿼리가 서로 다른 결과를 반환.
3. **팬텀 리드(Phantom Read)**: 쿼리를 반복 실행할 때 새로 삽입된 행으로 인해 결과가 달라짐.

---

## **트랜잭션 예시**

### 1. 은행 계좌 이체
```sql
START TRANSACTION;

-- A 계좌에서 100 출금
UPDATE accounts 
SET balance = balance - 100 
WHERE account_id = 'A';

-- B 계좌에 100 입금
UPDATE accounts 
SET balance = balance + 100 
WHERE account_id = 'B';

-- 모든 작업 확정
COMMIT;
```

#### 설명:
- 두 업데이트가 모두 성공하면 `COMMIT`으로 작업 확정.
- 하나라도 실패하면 `ROLLBACK`으로 취소하여 이전 상태로 복구.

---

### 2. 상품 재고 관리
```sql
START TRANSACTION;

-- 재고 확인
SELECT stock 
FROM products 
WHERE product_id = 1;

-- 재고 감소
UPDATE products 
SET stock = stock - 1 
WHERE product_id = 1;

COMMIT;
```

#### 설명:
- 재고 확인 후 감소 작업 수행.
- 재고 감소 중 오류 발생 시 `ROLLBACK`.

---

## 요약

| 속성        | 설명                                                                 |
|-------------|----------------------------------------------------------------------|
| 원자성       | 모든 작업이 완전히 수행되거나 전혀 수행되지 않아야 함                 |
| 일관성       | 데이터베이스가 항상 일관된 상태를 유지                               |
| 고립성       | 각 트랜잭션은 독립적으로 실행되어야 함                               |
| 지속성       | 커밋된 결과는 영구적으로 반영                                       |

트랜잭션은 데이터베이스 애플리케이션에서 데이터 무결성과 안정성을 보장하는 핵심 개념입니다. 이를 통해 중요한 작업(예: 금융 거래, 주문 처리 등)을 안전하게 수행할 수 있습니다. SQL 명령어와 격리 수준을 적절히 활용하여 다양한 상황에서 효율적이고 안전한 데이터 처리를 구현할 수 있습니다.
